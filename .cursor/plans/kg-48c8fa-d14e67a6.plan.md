<!-- d14e67a6-8378-48b8-9bac-74601fedde38 6190d575-12bf-4684-a346-42c5c2c9bde4 -->
# KG-AMTL CWRU 知识图谱拆分实现方案

## 1. 模块与文件划分设计

- **data 模块**
- 新建 [`data/cwru_loader.py`](data/cwru_loader.py)：
- 提供统一接口，如 `load_cwru_signals(root_dir, sample_length, num_samples_per_class, channel='DE')`。
- 按当前 `data/CRWU` 目录结构（12k/48k、Drive End/Fan End 等子目录）解析 `.mat` 文件；
- 将具体文件名到故障类型/工况的映射集中管理（例如一个 `FAULT_CONFIG` 字典或从 `configs/kg_cwru.yaml` 读取）。

- **preprocess 模块**
- 新建 [`preprocess/windowing.py`](preprocess/windowing.py)：
- 实现通用的滑动窗口/随机截取逻辑，如 `random_crop(signal, sample_length)` 和 `segment_signal(signal, frame_size, overlap)`；
- 为 `features` 层提供批量片段生成接口，支持配置窗口长度、重叠率等参数。

- **features 模块**
- 新建 [`features/time_domain.py`](features/time_domain.py)：
- 从 `KG_2_Final.extract_time_domain_features` 中抽取并轻量重构为纯函数接口；
- 保持 11 个时域特征以及顺序与 `TIME_FEATURE_NAMES` 完全一致。
- 新建 [`features/freq_domain.py`](features/freq_domain.py)：
- 抽取 `extract_frequency_domain_features`，封装为 `compute_frequency_features(signal, fs)`；
- 保持 12 个频域特征及其顺序与 `FREQ_FEATURE_NAMES` 一致。
- 新建 [`features/time_freq_vmd.py`](features/time_freq_vmd.py)：
- 抽取 `extract_vmd_features`，依赖 `vmdpy.VMD`，返回 4 个能量特征 + 4 个 SVD 特征；
- 提供接口配置 `K, alpha, tol` 等 VMD 参数。
- 新建 [`features/pipeline.py`](features/pipeline.py)：
- 实现 `extract_all_features(signal, fs, vmd_params)`，内部调用上述三个模块组合为 31 维向量；
- 实现 `batch_extract_features(signals, scaler=None, fit_scaler=True)`，完成批量特征提取与 MinMaxScaler 归一化；
- 将特征名称列表 `FULL_FEATURE_NAMES` 暴露给外部（与 `KG_2_Final` 保持一致）。

- **kg 模块**
- 新建 [`kg/fuzzy_c_means.py`](kg/fuzzy_c_means.py)：
- 从 `KG_2_Final.fuzzy_c_means` 中抽取实现，封装为 `fuzzy_c_means(X, n_clusters, m, max_iter, tol)`；
- 保留隶属度矩阵与聚类中心的计算逻辑，但与特定数据集解耦（不访问全局变量）。
- 新建 [`kg/weighting.py`](kg/weighting.py)：
- 抽取 `compute_correlation_matrix`，使其仅依赖 `features` 矩阵和类别数，返回 `W (C×D)`；
- 确保严格按 Steps/Doc5 中公式计算 `σ_ik` 和 `w_ik`，并在内部调用 `fuzzy_c_means`；
- 增加简单的数值稳定与日志输出配置（如最小 σ 截断）。
- 新建 [`kg/graph.py`](kg/graph.py)：
- 抽取并通用化 `build_knowledge_graph`、`save_knowledge_graph`；
- 不再直接打印路径，而是返回保存路径 dict，由脚本层决定是否打印；
- 支持选择保存格式（GraphML/GEXF/PKL/CSV/TSV）。
- 新建 [`kg/visualization.py`](kg/visualization.py)：
- 抽取 `draw_bipartite_graph`，接口接收 `G, feature_names, fault_names, save_path=None`；
- 支持在不显示图像的情况下仅保存 PNG（便于批处理）。
- 新建 [`kg/fault_evolution.py`](kg/fault_evolution.py)：
- 根据用户选择的 “手工设定示例矩阵” 方案：
- 定义故障状态集合 `fault_states = ['Normal', 'IR', 'OR', 'B', ...]`；
- 提供 `build_fault_transition_matrix(fault_states, preset='doc5_example')` 返回一个可编辑的转移概率矩阵；
- 用 `networkx.DiGraph` 构建有向图 `G_fault`，节点为故障状态，边权为 `P(i→j)`；
- 提供保存与（可选）简单可视化接口，与特征-故障 KG 的保存方式对齐。

- **configs 模块**
- 新建 [`configs/kg_cwru.yaml`](configs/kg_cwru.yaml)：
- 保存 CWRU 相关参数：数据根目录、使用的子集（如 12k Drive End）、`sample_length`、`num_samples_per_class`、采样频率 `fs`、VMD 参数、聚类与权重参数等；
- 配置要包含的故障类型及其与目录/文件名的映射键，以便 `data/cwru_loader.py` 读取。

- **scripts 模块**
- 新建 [`scripts/build_cwru_kg.py`](scripts/build_cwru_kg.py)：
- 作为命令行入口，读取 `configs/kg_cwru.yaml`，串联如下步骤：

1. 调用 `cwru_loader` 从 `data/CRWU` 加载指定故障类型的原始信号；
2. 使用 `features/pipeline` 对信号片段提取 31 维特征，并完成归一化；
3. 调用 `kg/weighting` 计算特征-故障相关矩阵 `W`；
4. 使用 `kg/graph` 构建并保存特征-故障双部知识图谱；
5. 调用 `kg/fault_evolution` 构建示例故障演化有向图并保存；
6. 根据配置选择是否调用 `kg/visualization` 输出图像到本地。

- 在 `__main__` 中使用 `argparse` 接收 `--config` 参数，默认指向 `configs/kg_cwru.yaml`。

## 2. 与现有 KG_2_Final 的对应与迁移

- **功能对照**
- 保留 `KG_2_Final.py` 中：
- 11 个时域特征公式；
- 12 个频域特征公式；
- VMD 能量 + SVD 特征的计算方式；
- Fuzzy C-Means 和 `W` 的计算流程；
- 双部图构建与保存逻辑；
- 将其拆解迁移到上述 `features/`、`kg/`、`scripts/` 模块中，保证：
- 特征向量的维度与顺序不变（方便后续与已有结果对比）；
- 相关矩阵 `W` 的形状及归一化性质（每行和≈1）保持一致。

- **与 Steps.md 的映射**
- **Step 1 (Physical Feature Extraction)**：对应 `features` 模块和 `scripts/build_cwru_kg.py` 里的特征提取部分；
- **Step 2 (Feature-Fault Correlation)**：对应 `kg/fuzzy_c_means.py` + `kg/weighting.py`；
- **Step 3 (Fault Evolution Graph)**：对应 `kg/fault_evolution.py` 中的手工示例转移矩阵 + 有向图构建。

## 3. 数据流与接口约定

- **数据流顺序**

1. `scripts/build_cwru_kg.py` 读取 YAML 配置，确定数据路径和参数；
2. 调用 `data/cwru_loader.load_cwru_signals`，从 `data/CRWU` 读取指定文件，返回 `signals (N×L)` 与 `labels (N,)`、`label_names`；
3. 将 `signals` 传入 `features/pipeline.batch_extract_features` 获取标准化特征矩阵 `X_features (N×31)`；
4. 将 `X_features` 与 `label_names`（或类别数）传入 `kg/weighting.compute_correlation_matrix` 得到 `W (C×31)`；
5. 将 `W`、`FULL_FEATURE_NAMES`、`label_names` 传入 `kg/graph.build_knowledge_graph`，得到双部图 `KG_bipartite` 并保存；
6. 使用 `kg/fault_evolution.build_fault_transition_matrix` + `build_fault_evolution_graph` 构建 `KG_fault` 并保存。

- **接口风格约定**
- 所有核心函数尽量纯函数化：输入 numpy 数组/简单 Python 结构，输出新的数组或 `networkx` 图，不在内部读写磁盘；
- 所有读写磁盘（.mat/.npz/.graphml/.csv/.png 等）的操作集中在 `data/` 模块和 `scripts/` 或专门的 `save_*` 函数中。

## 4. 后续可扩展点（非本次必须完成）

- 将 `fault_evolution` 中的手工示例转移矩阵替换为：
- 从配置或外部 CSV 读取的矩阵；
- 或根据 SRP/Doc5 中的实验序列自动统计得到的转移概率。
- 在 `kg/visualization.py` 中增加权重矩阵热力图、某类故障高权重特征 Top-K 条形图等辅助调试工具。
- 在 `tests/` 目录中添加针对 `features` 和 `kg` 的单元测试，验证特征维度、`W` 的归一化性质以及图中节点/边数量是否符合预期。

### To-dos

- [ ] 设计并实现 CWRU 数据加载与窗口切分接口（data/cwru_loader.py + preprocess/windowing.py），直接从 data/CRWU 下的 .mat 文件读取信号片段
- [ ] 实现并拆分 31 维多域物理特征提取（features 子模块），保持与 KG_2_Final 中特征和参数一致
- [ ] 实现模糊 C 均值聚类与特征-故障相关权重计算（kg/fuzzy_c_means.py 与 kg/weighting.py），复现 Steps 中 Step 2 公式
- [ ] 实现特征-故障双部知识图谱与故障演化有向图构建、保存与可视化（kg/graph.py、kg/fault_evolution.py、kg/visualization.py）
- [ ] 实现脚本 scripts/build_cwru_kg.py 与配置文件 configs/kg_cwru.yaml，将“数据→特征→权重→知识图谱”的完整流程串联起来